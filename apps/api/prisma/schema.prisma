generator client {
  provider = "prisma-client-js"
  output   = "../../../node_modules/.prisma/client"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                 String              @id @default(uuid())
  email              String              @unique
  name               String?
  passwordHash       String?
  status             UserStatus          @default(ACTIVE)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  authProvider       AuthProvider        @default(EMAIL)
  mfaBackupCodes     String[]            @default([])
  mfaEnabled         Boolean             @default(false)
  mfaSecret          String?
  auditLogs          AuditLog[]
  refreshTokens      RefreshToken[]
  roles              UserRole[]
  notifications      Notification[]
  qualityInspections QualityInspection[]
  supplierId         String? // Link to Supplier if this is a supplier user
  supplier           Supplier?           @relation(fields: [supplierId], references: [id])
  uploadedDocuments  PODocument[]
  poComments         POComment[]
  assignedBatches    ProductionBatch[]
  approvedExpenses   Expense[]           @relation("ApprovedExpenses")
}

model Role {
  id          String           @id @default(uuid())
  code        String           @unique
  name        String
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  permissions RolePermission[]
  users       UserRole[]
}

model Permission {
  id        String           @id @default(uuid())
  code      String           @unique
  name      String
  createdAt DateTime         @default(now())
  roles     RolePermission[]
}

model UserRole {
  userId String
  roleId String
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
}

model RolePermission {
  roleId       String
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  tokenHash String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model AuditLog {
  id         String   @id @default(uuid())
  actorId    String?
  action     String
  entityType String?
  entityId   String?
  metadata   Json?
  ip         String?
  userAgent  String?
  createdAt  DateTime @default(now())
  actor      User?    @relation(fields: [actorId], references: [id])

  @@index([actorId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

model Supplier {
  id                        String               @id @default(uuid())
  name                      String
  email                     String?              @unique
  phone                     String?
  address                   String?
  gstin                     String?              @unique
  paymentTerms              String?              @default("NET 30")
  rating                    Int?                 @default(0)
  notes                     String?
  createdAt                 DateTime             @default(now())
  updatedAt                 DateTime             @updatedAt
  approvalDate              DateTime?
  approvedBy                String?
  assignedTo                String?
  billingAddressLine1       String?
  billingAddressLine2       String?
  billingCity               String?
  billingCountry            String?
  billingLandmark           String?
  billingPinCode            String?
  billingState              String?
  businessType              String
  createdBy                 String?
  createdDate               DateTime             @default(now())
  lastModifiedBy            String?
  lastModifiedDate          DateTime             @updatedAt
  notesLegacy               String?
  primaryContactDesignation String?
  primaryContactEmail       String?
  primaryContactLandline    String?
  primaryContactMobile      String?
  primaryContactName        String?
  primaryContactWhatsApp    String?
  registeredAddressLine1    String?
  registeredAddressLine2    String?
  registeredCity            String?
  registeredCountry         String?
  registeredLandmark        String?
  registeredPinCode         String?
  registeredState           String?
  registrationDate          DateTime             @default(now())
  secondaryContactName      String?
  secondaryContactNumber    String?
  status                    String               @default("Active")
  supplierCode              String               @unique
  supplierType              String
  visibilityLevel           String?              @default("Public")
  warehouseAddressLine1     String?
  warehouseAddressLine2     String?
  warehouseCity             String?
  warehouseCountry          String?
  warehouseLandmark         String?
  warehousePinCode          String?
  warehouseState            String?
  rawMaterials              RawMaterial[]
  account                   SupplierAccount?
  material                  SupplierMaterial?
  performance               SupplierPerformance?
  pricing                   SupplierPricing?
  purchaseOrders            PurchaseOrder[]
  quotations                Quotation[]
  goodsReceipts             GoodsReceiptNote[]
  users                     User[]

  // Accounts Payable
  vendorInvoices            VendorInvoice[]
  vendorPayments            VendorPayment[]
  expenses                  Expense[]

  @@index([email])
  @@index([gstin])
  @@index([supplierCode])
  @@index([status])
}

model SupplierAccount {
  id                    String   @id @default(uuid())
  supplierId            String   @unique
  gstNumber             String?  @unique
  gstType               String?
  gstVerificationStatus String?  @default("Pending")
  panNumber             String?  @unique
  msmeRegNumber         String?  @unique
  udyamRegNumber        String?  @unique
  tradeLicenseNumber    String?  @unique
  iecNumber             String?  @unique
  tinNumber             String?  @unique
  tanNumber             String?  @unique
  tdsRate               Decimal? @db.Decimal(5, 2)
  stateJurisdiction     String?
  bankAccountHolderName String?
  bankName              String?
  bankAccountNumber     String?
  bankAccountType       String?
  bankIfscCode          String?
  bankBranchName        String?
  bankUpiId             String?
  bankAddress           String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  supplier              Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
}

model SupplierMaterial {
  id                   String   @id @default(uuid())
  supplierId           String   @unique
  materialsSupplied    String[]
  qualityGradesOffered String[]
  processingLevel      String?
  moistureContent      Decimal? @db.Decimal(5, 2)
  impurityLevel        Decimal? @db.Decimal(5, 2)
  colorMix             String?
  fiberLength          Decimal? @db.Decimal(8, 2)
  stapleLength         Decimal? @db.Decimal(8, 2)
  contaminationLevel   Int?
  monthlyCapacityTons  Decimal? @db.Decimal(10, 2)
  minimumOrderQuantity Decimal? @db.Decimal(10, 2)
  maximumOrderQuantity Decimal? @db.Decimal(10, 2)
  leadTimeDays         Int?
  deliveryFrequency    String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  supplier             Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
}

model SupplierPricing {
  id                     String   @id @default(uuid())
  supplierId             String   @unique
  basePricePerKg         Decimal? @db.Decimal(10, 2)
  priceBasedOnQuality    Boolean  @default(false)
  quantitySlabs          Json?
  seasonalPriceVariation Boolean  @default(false)
  creditPeriodDays       Int?
  advancePaymentPercent  Decimal? @db.Decimal(5, 2)
  paymentMethodsAccepted String[]
  earlyPaymentDiscount   Decimal? @db.Decimal(5, 2)
  latePaymentPenalty     Decimal? @db.Decimal(5, 2)
  deliveryMode           String?
  freightChargesBearer   String?
  deliveryAreaKm         Int?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  supplier               Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
}

model SupplierPerformance {
  id                       String    @id @default(uuid())
  supplierId               String    @unique
  avgQualityRating         Decimal?  @db.Decimal(3, 2)
  rejectionRate            Decimal?  @db.Decimal(5, 2)
  qualityConsistencyScore  Decimal?  @db.Decimal(5, 2)
  documentationAccuracy    Decimal?  @db.Decimal(5, 2)
  onTimeDeliveryPercent    Decimal?  @db.Decimal(5, 2)
  avgDelayDays             Decimal?  @db.Decimal(5, 2)
  orderFulfillmentRate     Decimal?  @db.Decimal(5, 2)
  emergencyOrderCapability Boolean   @default(false)
  paymentDefaultHistory    Boolean   @default(false)
  creditUtilization        Decimal?  @db.Decimal(5, 2)
  invoiceAccuracy          Decimal?  @db.Decimal(5, 2)
  disputeResolutionTime    Decimal?  @db.Decimal(8, 2)
  supplierScore            Int?
  riskLevel                String?
  performanceCategory      String?
  mandatoryDocuments       Json?
  qualityCertificates      Json?
  legalDocuments           Json?
  lastCommunicationDate    DateTime?
  communicationMethod      String?
  nextFollowUpDate         DateTime?
  communicationNotes       String?
  totalOrdersPlaced        Int       @default(0)
  totalQuantitySuppliedKg  Decimal?  @db.Decimal(12, 2)
  totalBusinessValue       Decimal?  @db.Decimal(12, 2)
  avgOrderValue            Decimal?  @db.Decimal(12, 2)
  lastOrderDate            DateTime?
  lastPaymentDate          DateTime?
  totalComplaints          Int       @default(0)
  resolvedComplaints       Int       @default(0)
  pendingComplaints        Int       @default(0)
  avgResolutionTimeHours   Decimal?  @db.Decimal(8, 2)
  strategicImportance      String?
  purchaseVolumeCategory   String?
  relationshipDuration     String?
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt
  supplier                 Supplier  @relation(fields: [supplierId], references: [id], onDelete: Cascade)
}

model SystemSettings {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String
  description String?
  updatedAt   DateTime @updatedAt
}

model RawMaterial {
  id                  String             @id @default(uuid())
  batchNo             String             @unique @db.VarChar(50)
  supplierId          String
  materialType        String
  quantity            Decimal            @db.Decimal(10, 2)
  unit                String             @default("kg")
  costPerUnit         Decimal            @db.Decimal(10, 2)
  totalCost           Decimal            @db.Decimal(12, 2)
  qualityScore        Decimal            @db.Decimal(4, 2)
  moistureContent     Decimal?           @db.Decimal(5, 2)
  receivedDate        DateTime
  warehouseLocationId String?
  warehouseLocation   WarehouseLocation? @relation(fields: [warehouseLocationId], references: [id])
  // Legacy string field, distinct from locationId
  legacyLocation      String?
  status              RawMaterialStatus  @default(IN_STOCK)
  notes               String?
  createdBy           String?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  productionBatches   ProductionBatch[]
  supplier            Supplier           @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@index([supplierId])
  @@index([batchNo])
  @@index([status])
}

model ProductionBatch {
  id            String            @id @default(uuid())
  batchNumber   String            @unique
  rawMaterialId String
  inputQuantity Decimal           @db.Decimal(10, 2)
  currentStage  StageName         @default(PLANNED)
  status        BatchStatus       @default(PENDING)
  qualityScore  Decimal?          @db.Decimal(5, 2)
  qualityGrade  String?           @db.VarChar(2)
  startDate     DateTime?
  endDate       DateTime?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  finishedGoods FinishedGood[]
  rawMaterial   RawMaterial       @relation(fields: [rawMaterialId], references: [id])
  stages        ProductionStage[]
  wastageLogs   WastageLog[]

  planId    String?
  plan      ProductionPlan? @relation(fields: [planId], references: [id])
  machineId String?
  machine   Machine?        @relation(fields: [machineId], references: [id])

  // Work Order & Shift & Operator
  workOrderId String?
  workOrder   WorkOrder? @relation(fields: [workOrderId], references: [id])
  shiftId     String?
  shift       Shift?     @relation(fields: [shiftId], references: [id])
  operatorId  String?
  operator    User?      @relation(fields: [operatorId], references: [id])

  @@index([status])
  @@index([currentStage])
}

model ProductionStage {
  id           String          @id @default(uuid())
  batchId      String
  stageName    StageName
  startTime    DateTime        @default(now())
  endTime      DateTime?
  operatorName String?
  machineId    String?
  status       String          @default("IN_PROGRESS")
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  batch        ProductionBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@index([batchId])
}

model WastageLog {
  id        String          @id @default(uuid())
  batchId   String
  stage     StageName
  quantity  Decimal         @db.Decimal(10, 2)
  wasteType String
  reason    String?
  loggedAt  DateTime        @default(now())
  userId    String?
  batch     ProductionBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@index([batchId])
}

model FinishedGood {
  id                  String             @id @default(uuid())
  batchId             String
  yarnCount           String
  producedQuantity    Decimal            @db.Decimal(10, 2)
  qualityGrade        String?
  packingDate         DateTime           @default(now())
  warehouseLocationId String?
  warehouseLocation   WarehouseLocation? @relation(fields: [warehouseLocationId], references: [id])
  legacyLocation      String?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  batch               ProductionBatch    @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@index([batchId])
}

enum UserStatus {
  ACTIVE
  DISABLED
}

enum AuthProvider {
  EMAIL
  GOOGLE
}

enum RawMaterialStatus {
  IN_STOCK
  QUALITY_CHECK
  CONSUMED
  RETURNED
}

enum StageName {
  PLANNED
  MIXING
  CARDING
  DRAWING
  ROVING
  SPINNING
  WINDING
  COMPLETED
}

enum BatchStatus {
  PENDING
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  data      Json?
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([createdAt])
}

enum NotificationType {
  INFO
  WARNING
  ERROR
  SUCCESS
  LOW_STOCK
  QUALITY_ALERT
  PAYMENT_DUE
  PRODUCTION_DELAY
}

// Quality Control System Models

model QualityInspection {
  id               String              @id @default(uuid())
  inspectionNumber String              @unique
  entityType       InspectionEntity
  entityId         String
  templateId       String?
  inspectorId      String?
  inspectionDate   DateTime            @default(now())
  status           InspectionStatus    @default(PENDING)
  result           InspectionResult?
  checklistItems   Json // Array of checklist items with pass/fail
  notes            String?
  photoUrls        String[]            @default([])
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  template         InspectionTemplate? @relation(fields: [templateId], references: [id])
  inspector        User?               @relation(fields: [inspectorId], references: [id])

  @@index([entityType, entityId])
  @@index([status])
  @@index([inspectionDate])
}

model QualityTest {
  id             String     @id @default(uuid())
  testNumber     String     @unique
  entityType     TestEntity
  entityId       String
  testDate       DateTime   @default(now())
  testParameters Json // Array of test parameters with values
  qualityScore   Decimal?   @db.Decimal(5, 2)
  qualityGrade   String?
  status         TestStatus @default(IN_PROGRESS)
  certificateUrl String?
  testedBy       String?
  notes          String?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  @@index([entityType, entityId])
  @@index([status])
  @@index([testDate])
}

model DefectLog {
  id                  String         @id @default(uuid())
  defectNumber        String         @unique
  entityType          DefectEntity
  entityId            String
  defectCategory      String
  defectType          String
  severity            DefectSeverity
  quantity            Decimal?       @db.Decimal(10, 2)
  description         String
  rootCause           String?
  correctiveAction    String?
  actionStatus        ActionStatus   @default(PENDING)
  actionDueDate       DateTime?
  actionCompletedDate DateTime?
  photoUrls           String[]       @default([])
  reportedBy          String?
  assignedTo          String?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt

  @@index([entityType, entityId])
  @@index([defectCategory])
  @@index([severity])
  @@index([actionStatus])
}

model InspectionTemplate {
  id             String              @id @default(uuid())
  name           String              @unique
  description    String?
  entityType     InspectionEntity
  checklistItems Json // Array of checklist items with criteria
  testParameters Json? // Optional test parameters
  isActive       Boolean             @default(true)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  inspections    QualityInspection[]
}

enum InspectionEntity {
  RAW_MATERIAL
  PRODUCTION_BATCH
}

enum TestEntity {
  RAW_MATERIAL
  PRODUCTION_BATCH
}

enum DefectEntity {
  RAW_MATERIAL
  PRODUCTION_BATCH
  FINISHED_GOOD
}

enum InspectionStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum InspectionResult {
  PASS
  FAIL
  CONDITIONAL_PASS
}

enum TestStatus {
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum DefectSeverity {
  CRITICAL
  MAJOR
  MINOR
}

enum ActionStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// Procurement & Purchase Order Models

model PurchaseOrder {
  id                   String    @id @default(uuid())
  poNumber             String    @unique
  supplierId           String
  orderDate            DateTime  @default(now())
  expectedDeliveryDate DateTime?
  status               POStatus  @default(DRAFT)
  totalAmount          Decimal   @db.Decimal(12, 2)
  notes                String?
  termsAndConditions   String?
  createdBy            String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  supplier          Supplier            @relation(fields: [supplierId], references: [id])
  vendorInvoices    VendorInvoice[]
  items             PurchaseOrderItem[]
  goodsReceiptNotes GoodsReceiptNote[]
  documents         PODocument[]
  comments          POComment[]
}

model PurchaseOrderItem {
  id               String  @id @default(uuid())
  purchaseOrderId  String
  materialType     String
  description      String?
  quantity         Decimal @db.Decimal(10, 2)
  unit             String
  unitPrice        Decimal @db.Decimal(10, 2)
  totalPrice       Decimal @db.Decimal(12, 2)
  receivedQuantity Decimal @default(0) @db.Decimal(10, 2)

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
}

model RequestForQuotation {
  id          String    @id @default(uuid())
  rfqNumber   String    @unique
  title       String
  description String?
  deadline    DateTime?
  status      RFQStatus @default(OPEN)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdBy   String?

  items      RFQItem[]
  quotations Quotation[]
}

model RFQItem {
  id             String  @id @default(uuid())
  rfqId          String
  materialType   String
  quantity       Decimal @db.Decimal(10, 2)
  unit           String
  specifications String?

  rfq RequestForQuotation @relation(fields: [rfqId], references: [id], onDelete: Cascade)
}

model Quotation {
  id              String          @id @default(uuid())
  rfqId           String
  supplierId      String
  quotationNumber String?
  quotationDate   DateTime        @default(now())
  validUntil      DateTime?
  totalAmount     Decimal         @db.Decimal(12, 2)
  status          QuotationStatus @default(PENDING)
  notes           String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  rfq      RequestForQuotation @relation(fields: [rfqId], references: [id], onDelete: Cascade)
  supplier Supplier            @relation(fields: [supplierId], references: [id])
  items    QuotationItem[]
}

model QuotationItem {
  id           String  @id @default(uuid())
  quotationId  String
  materialType String
  quantity     Decimal @db.Decimal(10, 2)
  unit         String
  unitPrice    Decimal @db.Decimal(10, 2)
  totalPrice   Decimal @db.Decimal(12, 2)
  remarks      String?

  quotation Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
}

model GoodsReceiptNote {
  id              String   @id @default(uuid())
  grnNumber       String   @unique
  purchaseOrderId String?
  supplierId      String
  receivedDate    DateTime @default(now())
  challanNumber   String?
  invoiceNumber   String?
  receivedBy      String?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  purchaseOrder PurchaseOrder?         @relation(fields: [purchaseOrderId], references: [id])
  supplier      Supplier               @relation(fields: [supplierId], references: [id])
  items         GoodsReceiptNoteItem[]
}

model GoodsReceiptNoteItem {
  id           String  @id @default(uuid())
  grnId        String
  materialType String
  quantity     Float
  unit         String
  batchNumber  String? // Assigned batch number for inventory
  remarks      String?

  grn GoodsReceiptNote @relation(fields: [grnId], references: [id], onDelete: Cascade)
}

model PODocument {
  id               String        @id @default(uuid())
  purchaseOrderId  String
  purchaseOrder    PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  type             String // INVOICE, PACKING_SLIP, OTHER
  url              String
  uploadedByUserId String
  uploadedByUser   User          @relation(fields: [uploadedByUserId], references: [id])
  createdAt        DateTime      @default(now())
}

model POComment {
  id              String        @id @default(uuid())
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  userId          String
  user            User          @relation(fields: [userId], references: [id])
  message         String
  createdAt       DateTime      @default(now())
}

enum POStatus {
  DRAFT
  SENT
  CONFIRMED
  PARTIALLY_RECEIVED
  COMPLETED
  CANCELLED
}

enum RFQStatus {
  OPEN
  CLOSED
  CANCELLED
}

enum QuotationStatus {
  PENDING
  ACCEPTED
  REJECTED
}

model ProductionPlan {
  id        String            @id @default(uuid())
  name      String
  startDate DateTime
  endDate   DateTime
  status    String            @default("DRAFT") // DRAFT, APPROVED, COMPLETED
  notes     String?
  batches   ProductionBatch[]
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
}

model DemandForecast {
  id                 String   @id @default(uuid())
  month              Int
  year               Int
  productType        String
  forecastedQuantity Decimal  @db.Decimal(10, 2)
  confidenceLevel    Int      @default(80) // Percentage
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@unique([month, year, productType])
}

model Machine {
  id                 String              @id @default(uuid())
  name               String
  code               String              @unique
  type               String // e.g. SPINNING, CARDING
  capacityPerHour    Decimal             @db.Decimal(10, 2)
  status             String              @default("ACTIVE") // ACTIVE, MAINTENANCE, DOWN
  batches            ProductionBatch[]
  maintenanceRecords MaintenanceRecord[]
  downtimeLogs       DowntimeLog[]
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
}

model MaintenanceRecord {
  id          String   @id @default(uuid())
  machineId   String
  machine     Machine  @relation(fields: [machineId], references: [id])
  type        String // PREVENTIVE, BREAKDOWN
  date        DateTime
  technician  String?
  description String?
  cost        Decimal? @db.Decimal(10, 2)
  status      String   @default("COMPLETED")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model DowntimeLog {
  id              String    @id @default(uuid())
  machineId       String
  machine         Machine   @relation(fields: [machineId], references: [id])
  startTime       DateTime
  endTime         DateTime?
  durationMinutes Int?
  reason          String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model SparePart {
  id                String   @id @default(uuid())
  name              String
  partNumber        String   @unique
  quantityInStock   Int
  minimumStockLevel Int
  costPerUnit       Decimal  @db.Decimal(10, 2)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// Warehouse Management Models

model Warehouse {
  id                   String                @id @default(uuid())
  name                 String
  code                 String                @unique
  type                 String // RAW_MATERIAL, FINISHED_GOODS, GENERAL
  address              String?
  managerId            String?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  locations            WarehouseLocation[]
  stockIn              StockMovementLog[]    @relation("FromWarehouse")
  stockOut             StockMovementLog[]    @relation("ToWarehouse")
  stockReconciliations StockReconciliation[]
}

model WarehouseLocation {
  id           String    @id @default(uuid())
  warehouseId  String
  warehouse    Warehouse @relation(fields: [warehouseId], references: [id])
  code         String // e.g., Z1-R1-B1
  zone         String?
  rack         String?
  bin          String?
  capacity     Decimal?  @db.Decimal(10, 2)
  currentUsage Decimal?  @db.Decimal(10, 2)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  rawMaterials  RawMaterial[]
  finishedGoods FinishedGood[]
  stockLogs     StockMovementLog[]

  @@unique([warehouseId, code])
}

model StockTransfer {
  id                    String    @id @default(uuid())
  transferNumber        String    @unique
  sourceLocationId      String?
  destinationLocationId String
  status                String    @default("PENDING") // PENDING, APPROVED, COMPLETED
  items                 Json // Details of items moved
  requestedBy           String?
  approvedBy            String?
  completedAt           DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
}

model StockMovementLog {
  id       String  @id @default(uuid())
  type     String // IN, OUT, TRANSFER, ADJUSTMENT
  itemId   String // ID of RawMaterial or FinishedGood
  itemType String // RAW_MATERIAL, FINISHED_GOOD
  quantity Decimal @db.Decimal(10, 2)

  locationId String?
  location   WarehouseLocation? @relation(fields: [locationId], references: [id])

  fromWarehouseId String?
  fromWarehouse   Warehouse? @relation("FromWarehouse", fields: [fromWarehouseId], references: [id])

  toWarehouseId String?
  toWarehouse   Warehouse? @relation("ToWarehouse", fields: [toWarehouseId], references: [id])

  referenceType String? // PO, SO, PRODUCTION, TRANSFER
  referenceId   String?

  performedBy String?
  createdAt   DateTime @default(now())
}

// Shift Management
model Shift {
  id        String            @id @default(uuid())
  name      String
  startTime String // Format "HH:mm"
  endTime   String // Format "HH:mm"
  isActive  Boolean           @default(true)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  batches   ProductionBatch[]
}

// Work Order Management
model WorkOrder {
  id              String            @id @default(uuid())
  workOrderNumber String            @unique
  priority        Priority          @default(MEDIUM)
  status          WorkOrderStatus   @default(PENDING)
  startDate       DateTime?
  dueDate         DateTime?
  notes           String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  batches         ProductionBatch[]
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum WorkOrderStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model InventoryOptimization {
  id           String   @id @default(uuid())
  materialType String   @unique
  reorderPoint Decimal  @db.Decimal(10, 2)
  safetyStock  Decimal  @db.Decimal(10, 2)
  leadTimeDays Int      @default(7)
  eoq          Decimal? @db.Decimal(10, 2) // Economic Order Quantity
  abcCategory  String? // A, B, or C
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([materialType])
}

model StockReconciliation {
  id          String               @id @default(uuid())
  reconcileNo String               @unique
  warehouseId String
  warehouse   Warehouse            @relation(fields: [warehouseId], references: [id])
  status      ReconcileStatus      @default(PENDING)
  notes       String?
  items       ReconciliationItem[]
  startedBy   String?
  finalizedBy String?
  finalizedAt DateTime?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  @@index([warehouseId])
  @@index([status])
}

model ReconciliationItem {
  id               String              @id @default(uuid())
  reconciliationId String
  reconciliation   StockReconciliation @relation(fields: [reconciliationId], references: [id], onDelete: Cascade)
  itemId           String // RawMaterial or FinishedGood ID
  itemType         String // RAW_MATERIAL, FINISHED_GOOD
  itemName         String
  systemQuantity   Decimal             @db.Decimal(10, 2)
  physicalQuantity Decimal?            @db.Decimal(10, 2)
  difference       Decimal?            @db.Decimal(10, 2)
  notes            String?

  @@index([reconciliationId])
}

enum ReconcileStatus {
  PENDING
  COMPLETED
  CANCELLED
}

// Billing & Invoice Models

model Invoice {
  id            String        @id @default(uuid())
  invoiceNumber String        @unique
  customerName  String
  customerId    String?
  date          DateTime      @default(now())
  billingCycle  String? // e.g., "Jan 2026"
  totalAmount   Decimal       @db.Decimal(12, 2)
  taxAmount     Decimal       @default(0) @db.Decimal(12, 2)
  status        InvoiceStatus @default(PENDING)
  notes         String?
  items         InvoiceItem[]
  templateName    String?       @default("STANDARD")
  paymentLink     String?

  // Advanced Features
  isRecurring     Boolean                 @default(false)
  recurringConfig RecurringBillingConfig?
  creditNotes     CreditNote[]
  debitNotes      DebitNote[]

  customer      Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  payments      ARPayment[]
  followUps     ARFollowUp[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([customerName])
  @@index([status])
  @@index([date])
}

model Customer {
  id          String   @id @default(uuid())
  name        String   @unique
  email       String?
  phone       String?
  address     String?
  gstin       String?
  creditLimit Decimal? @db.Decimal(12, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  invoices         Invoice[]
  payments         ARPayment[]
  followUps        ARFollowUp[]
  badDebtProvisions BadDebtProvision[]

  @@index([name])
}

model ARPayment {
  id          String   @id @default(uuid())
  customerId  String
  invoiceId   String?
  amount      Decimal  @db.Decimal(12, 2)
  method      String? // CASH, BANK_TRANSFER, UPI, ONLINE
  reference   String?
  date        DateTime @default(now())
  notes       String?
  createdBy   String?
  createdAt   DateTime @default(now())

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  invoice  Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  @@index([customerId])
  @@index([invoiceId])
  @@index([date])
}

model ARFollowUp {
  id         String          @id @default(uuid())
  customerId String
  invoiceId  String?
  status     FollowUpStatus  @default(OPEN)
  dueDate    DateTime?
  notes      String?
  createdBy  String?
  createdAt  DateTime        @default(now())
  completedAt DateTime?

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  invoice  Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  @@index([customerId])
  @@index([invoiceId])
  @@index([status])
  @@index([dueDate])
}

enum FollowUpStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model BadDebtProvision {
  id          String   @id @default(uuid())
  customerId  String
  amount      Decimal  @db.Decimal(12, 2)
  provisionDate DateTime @default(now())
  notes       String?
  createdBy   String?
  createdAt   DateTime @default(now())

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([provisionDate])
}

model CreditNote {
  id              String           @id @default(uuid())
  creditNoteNumber String           @unique
  invoiceId       String?
  invoice         Invoice?         @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  customerName    String
  date            DateTime         @default(now())
  amount          Decimal          @db.Decimal(12, 2)
  reason          CreditNoteReason @default(RETURNED_GOODS)
  notes           String?
  
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([customerName])
  @@index([invoiceId])
}

model DebitNote {
  id              String   @id @default(uuid())
  debitNoteNumber String   @unique
  invoiceId       String?
  invoice         Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  customerName    String
  date            DateTime @default(now())
  amount          Decimal  @db.Decimal(12, 2)
  reason          String
  notes           String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([customerName])
  @@index([invoiceId])
}

enum CreditNoteReason {
  RETURNED_GOODS
  OVERCHARGED
  DAMAGED_ITEMS
  OTHER
}

model InvoiceItem {
  id          String  @id @default(uuid())
  invoiceId   String
  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  description String
  quantity    Decimal @db.Decimal(10, 2)
  unitPrice   Decimal @db.Decimal(12, 2)
  totalPrice  Decimal @db.Decimal(12, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([invoiceId])
}

model RecurringBillingConfig {
  id          String           @id @default(uuid())
  invoiceId   String           @unique
  invoice     Invoice          @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  frequency   BillingFrequency @default(MONTHLY)
  nextRunDate DateTime
  isActive    Boolean          @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum InvoiceStatus {
  PAID
  PENDING
  OVERDUE
  VOID
}

enum BillingFrequency {
  MONTHLY
  QUARTERLY
  ANNUALLY
}

// Accounts Payable Models

model VendorInvoice {
  id              String   @id @default(uuid())
  invoiceNumber   String
  supplierId      String
  purchaseOrderId String?
  date            DateTime
  dueDate         DateTime
  totalAmount     Decimal  @db.Decimal(12, 2)
  status          BillStatus @default(OPEN)
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  supplier      Supplier       @relation(fields: [supplierId], references: [id])
  purchaseOrder PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id])
  payments      VendorPayment[]

  @@unique([supplierId, invoiceNumber])
  @@index([supplierId])
  @@index([status])
}

model VendorPayment {
  id          String   @id @default(uuid())
  supplierId  String
  invoiceId   String?
  amount      Decimal  @db.Decimal(12, 2)
  paymentDate DateTime @default(now())
  method      String   // CASH, BANK_TRANSFER, UPI, CHEQUE
  reference   String?
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  supplier Supplier       @relation(fields: [supplierId], references: [id])
  invoice  VendorInvoice? @relation(fields: [invoiceId], references: [id])

  @@index([supplierId])
  @@index([invoiceId])
}

model Expense {
  id          String   @id @default(uuid())
  category    String   // Rent, Utilities, Salary
  amount      Decimal  @db.Decimal(12, 2)
  date        DateTime @default(now())
  description String
  supplierId  String?
  vendorName  String?  // If not a registered supplier
  status      ExpenseStatus @default(PENDING)
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  supplier Supplier? @relation(fields: [supplierId], references: [id])
  
  approverId      String?
  approver        User?          @relation("ApprovedExpenses", fields: [approverId], references: [id])
  approvalDate    DateTime?
  rejectionReason String?

  @@index([category])
  @@index([date])
}

model Budget {
  id        String   @id @default(uuid())
  category  String
  amount    Decimal  @db.Decimal(12, 2)
  periodKey String   // Format "YYYY-MM"
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([category, periodKey])
}

enum BillStatus {
  OPEN
  PARTIAL
  PAID
  OVERDUE
  VOID
}

enum ExpenseStatus {
  PENDING
  APPROVED
  REJECTED
  PAID
}


